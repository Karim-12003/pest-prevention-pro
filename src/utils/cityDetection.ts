
// List of German cities for detection
export const cityList = [
  'Aachen', 'Ahaus', 'Ahlen', 'Alfter', 'Altena', 'Altenbeken', 'Anröchte',
  'Arnsberg', 'Ascheberg', 'Attendorn', 'Augustdorf', 
  'Bad Berleburg', 'Bad Honnef', 'Bad Laasphe', 'Bad Oeynhausen', 'Bad Salzuflen', 
  'Beckum', 'Bedburg', 'Bergheim', 'Bergisch Gladbach', 'Bergkamen', 'Bergneustadt',
  'Berlin', 'Bestwig', 'Beverungen', 'Bielefeld', 'Billerbeck', 'Bocholt', 'Bochum', 
  'Bonn', 'Borchen', 'Borgentreich', 'Borgholzhausen', 'Borken', 'Bornheim', 'Bottrop', 
  'Brakel', 'Bremen', 'Brühl', 'Bünde', 'Burbach', 'Burscheid', 
  'Castrop-Rauxel', 'Coesfeld', 
  'Datteln', 'Delbrück', 'Detmold', 'Dinslaken', 'Dormagen', 'Dorsten', 'Dortmund', 
  'Dresden', 'Drolshagen', 'Duisburg', 'Dülmen', 'Düsseldorf', 
  'Emmerich', 'Emsdetten', 'Enge', 'Enger', 'Engelskirchen', 'Ennepetal', 'Ennigerloh', 
  'Erftstadt', 'Erkenschwick', 'Erkrath', 'Erndtebrück', 'Erzgebirge', 'Eschweiler', 'Essen', 'Eslohe', 
  'Espelkamp', 'Essen', 'Extertal', 
  'Frankfurt', 'Frechen', 'Freiburg', 'Freudenberg', 
  'Gelsenkirchen', 'Gescher', 'Geseke', 'Gevelsberg', 'Gladbeck', 'Greven', 'Grevenbroich', 
  'Gütersloh', 'Gummersbach', 
  'Haan', 'Hagen', 'Haltern', 'Haltern am See', 'Halver', 'Hamburg', 'Hamm', 'Hamminkeln', 'Hannover', 
  'Harsewinkel', 'Hattingen', 'Havixbeck', 'Heek', 'Heiligenhaus', 'Herdecke', 'Herford', 'Herne', 'Herten', 
  'Herzogenrath', 'Hilchenbach', 'Hilden', 'Hille', 'Horn-Bad Meinberg', 'Hörstel', 'Hövel', 'Hövelhof', 
  'Höxter', 'Hückeswagen', 'Hünxe', 'Hürth', 'Hüllhorst', 
  'Ibbenbüren', 'Iserlohn', 'Isselburg', 
  'Jüchen', 
  'Kaarst', 'Kamen', 'Kamp-Lintfort', 'Karlsruhe', 'Kerpen', 'Kierspe', 'Kirchhundem', 'Kleve', 'Köln', 
  'Königswinter', 'Korschenbroich', 'Krefeld', 'Kreuztal', 'Kürten', 
  'Lage', 'Langenfeld', 'Leipzig', 'Leichlingen', 'Lemgo', 'Lengerich', 'Lennestadt', 
  'Leverkusen', 'Lichtenau', 'Lindlar', 'Lippspringe', 'Lippstadt', 'Lübbecke', 'Lüdenscheid', 
  'Lüdinghausen', 'Lünen', 
  'Mannheim', 'Marienmünster', 'Marienheide', 'Marl', 'Marsberg', 'Medebach', 'Meerbusch', 
  'Meinerzhagen', 'Menden', 'Meckenheim', 'Meschede', 'Mettmann', 'Minden', 'Moers', 'Monheim', 
  'Monheim am Rhein', 'Monschau', 'Mönchengladbach', 'Morsbach', 'Much', 'München', 'Münster', 
  'Netphen', 'Neuenrade', 'Neunkirchen', 'Neuss', 'Neustadt', 'Niederkassel', 'Nieheim', 
  'Nottuln', 'Nümbrecht', 'Nürnberg', 'Neukirchen-Vluyn',
  'Oberhausen', 'Oberveischede', 'Ochtrup', 'Odenthal', 'Oelde', 'Oer-Erkenschwick', 'Olfen', 
  'Olpe', 'Olsberg', 'Ostbevern', 'Overath', 
  'Paderborn', 'Petershagen', 'Plettenberg', 'Porta Westfalica', 'Preußisch Oldendorf', 'Pulheim', 
  'Radevormwald', 'Raesfeld', 'Ratingen', 'Recklinghausen', 'Rees', 'Reichshof', 'Remscheid', 
  'Rheda-Wiedenbrück', 'Rhede', 'Rheinberg', 'Rheine', 'Rietberg', 'Roetgen', 'Rommerskirchen', 
  'Rosendahl', 'Rösrath', 'Rüthen', 
  'Salzkotten', 'Sankt Augustin', 'Sassenberg', 'Schalksmühle', 'Schermbeck', 'Schieder-Schwalenberg', 
  'Schloß Holte-Stukenbrock', 'Schmallenberg', 'Schwelm', 'Schwerte', 'Selm', 'Senden', 'Sendenhorst', 
  'Siegburg', 'Siegen', 'Simmerath', 'Soest', 'Solingen', 'Sprockhövel', 'Stadtlohn', 'Steinfurt', 
  'Steinhagen', 'Steinheim', 'Stemwede', 'Stolberg', 'Stuttgart', 'Südlohn', 'Sundern', 
  'Telgte', 'Troisdorf', 
  'Unna', 
  'Velbert', 'Verl', 'Viersen', 'Voerde', 'Vreden', 
  'Wadersloh', 'Waldbröl', 'Waltrop', 'Warendorf', 'Warburg', 'Warstein', 'Wenden', 'Werl', 
  'Wermelskirchen', 'Wesel', 'Wesseling', 'Westerkappeln', 'Wetter', 'Wickede', 'Wiehl', 'Willebadessen', 
  'Willich', 'Wilnsdorf', 'Winterberg', 'Wipperfürth', 'Witten', 'Wuppertal', 'Würselen', 
  'Xanten'
];

// Cities with postal codes for impressum/AGB pages
export const cityListWithPostalCodes = [
  { city: 'Essen', plz: '45127' },
  { city: 'Dortmund', plz: '44137' },
  { city: 'Duisburg', plz: '47051' },
  { city: 'Bochum', plz: '44787' },
  { city: 'Herne', plz: '44623' },
  { city: 'Gelsenkirchen', plz: '45879' },
  { city: 'Oberhausen', plz: '46045' },
  { city: 'Bottrop', plz: '46236' },
  { city: 'Mülheim', plz: '45468' },
  { city: 'Hagen', plz: '58135' },
  { city: 'Recklinghausen', plz: '45657' },
  { city: 'Köln', plz: '50667' },
  { city: 'Berlin', plz: '10115' },
  { city: 'Hamburg', plz: '20095' },
  { city: 'München', plz: '80331' },
  { city: 'Frankfurt', plz: '60311' },
  { city: 'Stuttgart', plz: '70173' },
];

export const DEFAULT_CITY = "Ihrer Stadt";
export const DEFAULT_PLZ = "58135";

/**
 * Detects the city from URL parameters or the URL itself
 * @returns The detected city name or the default city
 */
export const detectCityFromURL = () => {
  console.log("Stadt-Erkennung wird ausgeführt...");
  let detectedCity = DEFAULT_CITY;
  
  try {
    // Google Ads Parameter "kw" (keyword) überprüfen
    const urlParams = new URLSearchParams(window.location.search);
    const kwParam = urlParams.get('kw');
    
    if (kwParam) {
      console.log("kw-Parameter gefunden:", kwParam);
      const decodedKw = decodeURIComponent(kwParam);
      console.log("Dekodierter kw-Parameter:", decodedKw);
      
      // Die Wörter des Parameters aufteilen
      const words = decodedKw.toLowerCase().split(/\s+/);
      console.log("Aufgeteilte Wörter:", words);
      
      // Jedes Wort mit unserer Städteliste vergleichen
      for (const city of cityList) {
        const cityLower = city.toLowerCase();
        
        // Prüfen ob Stadt komplett im Parameter enthalten ist
        if (decodedKw.toLowerCase().includes(cityLower)) {
          console.log(`Stadt "${city}" im Keyword gefunden!`);
          return city;
        }
        
        // Einzelwortvergleich für genauere Erkennung
        for (const word of words) {
          if (word === cityLower || (word.length > 3 && cityLower.includes(word))) {
            console.log(`Stadt "${city}" aus Teilwort "${word}" erkannt!`);
            return city;
          }
        }
      }
      
      // Speziell für "bochum" prüfen (da dies in der URL vorkommt)
      if (decodedKw.toLowerCase().includes("bochum")) {
        console.log("Bochum explizit erkannt!");
        return "Bochum";
      }
    }
    
    // Falls kein Parameter gefunden wurde, auch die URL selbst prüfen
    const fullUrl = window.location.href.toLowerCase();
    for (const city of cityList) {
      if (fullUrl.includes(city.toLowerCase())) {
        console.log(`Stadt "${city}" in der URL gefunden!`);
        return city;
      }
    }
    
    // Speziell für "bochum" in der URL prüfen
    if (fullUrl.includes("bochum")) {
      console.log("Bochum explizit in der URL erkannt!");
      return "Bochum";
    }
    
    console.log("Keine Stadt erkannt, verwende Standardwert:", DEFAULT_CITY);
    return DEFAULT_CITY;
  } catch (error) {
    console.error("Fehler bei der Stadt-Erkennung:", error);
    return DEFAULT_CITY;
  }
};

/**
 * Detects city with postal code for legal pages
 * @param routeCity Optional city from route parameters
 * @returns Object with city and postal code
 */
export const detectCityWithPostalCode = (routeCity?: string) => {
  console.log("City detection with postal code running...");
  
  // First check route parameter
  if (routeCity) {
    console.log("Route city found:", routeCity);
    const foundCity = cityListWithPostalCodes.find(item => 
      item.city.toLowerCase() === routeCity.toLowerCase()
    );
    
    if (foundCity) {
      console.log("City matched from route:", foundCity);
      return foundCity;
    }
  }
  
  // Then check URL for kw parameter
  const urlParams = new URLSearchParams(window.location.search);
  const kwParam = urlParams.get('kw');
  
  if (kwParam) {
    console.log("kw param found:", kwParam);
    const decodedKw = decodeURIComponent(kwParam).toLowerCase();
    
    for (const cityData of cityListWithPostalCodes) {
      if (decodedKw.includes(cityData.city.toLowerCase())) {
        console.log("City matched from kw param:", cityData);
        return cityData;
      }
    }
  }
  
  // Check full URL for city name
  const fullUrl = window.location.href.toLowerCase();
  console.log("Checking full URL:", fullUrl);
  
  for (const cityData of cityListWithPostalCodes) {
    if (fullUrl.includes(cityData.city.toLowerCase())) {
      console.log("City matched from URL:", cityData);
      return cityData;
    }
  }
  
  // Default if no city is found
  console.log("No city detected, using default:", DEFAULT_CITY);
  return { city: DEFAULT_CITY, plz: DEFAULT_PLZ };
};

/**
 * Updates city placeholder elements in the DOM
 * @param cityName The city name to insert into placeholders
 */
export const updateCityPlaceholders = (cityName: string) => {
  const cityPlaceholders = document.querySelectorAll('.city-placeholder');
  console.log(`${cityPlaceholders.length} city-placeholder Elemente gefunden`);
  
  cityPlaceholders.forEach((el, index) => {
    const oldText = el.textContent;
    console.log(`city-placeholder Element ${index + 1} enthält:`, oldText);
    
    // Aktualisieren der Platzhalter mit dem aktuellen cityName
    if (oldText !== cityName) {
      el.textContent = cityName;
      console.log(`Platzhalter ${index + 1} von "${oldText}" zu "${cityName}" aktualisiert`);
    }
  });
};
