
// ─── Hybrid City Detection ──────────────────────────────────────────────────

// 1) Lookup-Tabelle: Geo-ID → Stadtname
const geoIdToCity = {
  "1004618": "Ennepetal",
  "1004592": "Bergkamen",
  "1004596": "Bochum",
  "9048825": "Voerde (Niederrhein)",
  "1004610": "Dorsten",
  "9048668": "Raesfeld",
  "1004710": "Oberhausen",
  "1004690": "Lünen",
  "9196810": "Selm",
  "9048269": "Datteln",
  "1004642": "Hamm",
  "1004601": "Bottrop",
  "9048453": "Hünxe",
  "9048374": "Gladbeck",
  "1004631": "Gelsenkirchen",
  "1004762": "Wesel",
  "1004611": "Dortmund",
  "1004652": "Herten",
  "1004702": "Moers",
  "1004641": "Haltern am See",
  "1004706": "Mülheim an der Ruhr",
  "1004612": "Duisburg",
  "1004692": "Marl",
  "1004771": "Xanten",
  "9048844": "Waltrop",
  "9048281": "Dinslaken",
  "1004625": "Essen",
  "9062603": "Schermbeck",
  "1004605": "Castrop-Rauxel",
  "1004651": "Herne",
  "1004768": "Witten",
  "1028816": "Hagen",
  "1004746": "Unna",
  "9048467": "Kamen",
  "1004721": "Recklinghausen",
  "1004731": "Schwerte",
  "9048597": "Neukirchen-Vluyn",
  "9048635": "Oer-Erkenschwick",
  "9048398": "Hamminkeln",
  "9048468": "Kamp-Lintfort",
  "9048256": "Brühl",
  "1004736": "Solingen",
  "1004704": "Monheim am Rhein",
  "1004674": "Korschenbroich",
  "9062605": "Jüchen",
  "1004708": "Neuss",
  "1004747": "Velbert",
  "9048179": "Bad Honnef",
  "9048676": "Rees",
  "1004636": "Grevenbroich",
  "1004615": "Düsseldorf",
  "9048866": "Wesseling",
  "1004700": "Mettmann",
  "1004579": "Alfter",
  "1004619": "Erftstadt",
  "9048240": "Bornheim",
  "1004745": "Troisdorf",
  "1004678": "Langenfeld (Rheinland)",
  "1004722": "Remscheid",
  "1004609": "Dormagen",
  "1004662": "Hürth",
  "1004590": "Bergheim",
  "1004576": "Aachen",
  "1004673": "Kleve",
  "1004719": "Ratingen",
  "9048694": "Rommerskirchen",
  "1004669": "Kerpen",
  "1004695": "Meckenheim",
  "1004682": "Leverkusen",
  "1004616": "Emmerich am Rhein",
  "9048493": "Königswinter",
  "1004675": "Krefeld",
  "1004696": "Meerbusch",
  "1004655": "Hilden",
  "1004666": "Kaarst",
  "1004703": "Mönchengladbach",
  "1004718": "Pulheim",
  "1004628": "Frechen",
  "1004709": "Niederkassel",
  "1004589": "Bedburg",
  "1004733": "Siegburg",
  "1004597": "Bonn",
  "1004738": "Sankt Augustin",
  "1004607": "Köln",
  "1004707": "Münster",
  "1004711": "Oelde",
  "1004617": "Emsdetten",
  "9062602": "Heek",
  "9062599": "Rhede",
  "1004757": "Warendorf",
  "1004578": "Ahlen",
  "9062594": "Südlohn",
  "9210539": "Ostbevern",
  "1004635": "Greven",
  "9048755": "Sendenhorst",
  "1004599": "Borken",
  "1004594": "Billerbeck",
  "9048619": "Nottuln",
  "9062592": "Havixbeck",
  "1004689": "Lüdinghausen",
  "1004577": "Ahaus",
  "9048461": "Isselburg",
  "9048711": "Sassenberg",
  "9048754": "Senden",
  "1004588": "Beckum",
  "1004657": "Hörstel",
  "1004739": "Stadtlohn",
  "1004724": "Rheine",
  "1004712": "Olfen",
  "1004680": "Lengerich",
  "1004752": "Vreden",
  "9048792": "Telgte",
  "1004740": "Steinfurt",
  "1004613": "Dülmen",
  "9062596": "Rosendahl",
  "9214328": "Wadersloh",
  "1004606": "Coesfeld",
  "9048370": "Gescher",
  "9048319": "Ennigerloh",
  "1004663": "Ibbenbüren",
  "9196211": "Ochtrup",
  "9048161": "Ascheberg",
  "1004741": "Steinhagen",
  "1004593": "Bielefeld",
  "9048243": "Brakel",
  "9215569": "Schieder-Schwalenberg",
  "1004728": "Salzkotten",
  "1004602": "Bünde",
  "9048652": "Petershagen",
  "1004679": "Lemgo",
  "1004723": "Rheda-Wiedenbrück",
  "9209090": "Preußisch Oldendorf",
  "9220962": "Altenbeken",
  "9048449": "Hövelhof",
  "1004715": "Paderborn",
  "9193263": "Oerlinghausen",
  "1004624": "Espelkamp",
  "9048318": "Enger",
  "9048724": "Schloß Holte-Stukenbrock",
  "9048448": "Horn-Bad Meinberg",
  "1004687": "Lübbecke",
  "1004608": "Detmold",
  "9189603": "Beverungen",
  "9193298": "Delbrück",
  "1003986": "Lichtenau",
  "9048190": "Bad Salzuflen",
  "1004585": "Bad Oeynhausen",
  "1004598": "Borchen",
  "1004725": "Rietberg",
  "1004717": "Porta Westfalica",
  "1004756": "Warburg",
  "1004639": "Gütersloh",
  "1004748": "Verl",
  "9048402": "Harsewinkel",
  "9048238": "Borgholzhausen",
  "1004650": "Herford",
  "9212883": "Augustdorf",
  "9217662": "Nieheim",
  "9219163": "Extertal",
  "1004701": "Minden",
  "1004659": "Höxter",
  "9048679": "Reichshof",
  "9048510": "Leichlingen (Rheinland)",
  "9048574": "Much",
  "1004729": "Schalksmühle",
  "1004737": "Sprockhövel",
  "1004671": "Kierspe",
  "9048834": "Waldbröl",
  "1004730": "Schwelm",
  "9048151": "Altena",
  "1004604": "Burscheid",
  "9191589": "Bergneustadt",
  "1004727": "Rösrath",
  "1004697": "Meinerzhagen",
  "1004714": "Overath",
  "9048620": "Nümbrecht",
  "1004649": "Herdecke",
  "9197635": "Halver",
  "9048316": "Engelskirchen",
  "1004591": "Bergisch Gladbach",
  "9217576": "Odenthal",
  "9195199": "Marienheide",
  "1004676": "Kürten",
  "1004763": "Wetter (Ruhr)",
  "1004764": "Wiehl",
  "9048521": "Lindlar",
  "1004767": "Wipperfürth",
  "1004705": "Morsbach",
  "9048667": "Radevormwald",
  "1004769": "Wuppertal",
  "1004643": "Hattingen",
  "1004761": "Wermelskirchen",
  "1004661": "Hückeswagen",
  "1004632": "Gevelsberg",
  "1004638": "Gummersbach",
  "9048847": "Warstein",
  "1004583": "Attendorn",
  "9048513": "Lennestadt",
  "1004766": "Winterberg",
  "1004693": "Marsberg",
  "1004629": "Freudenberg",
  "9048371": "Geseke",
  "9048599": "Neunkirchen",
  "1004735": "Soest",
  "9217732": "Erndtebrück",
  "1004584": "Bad Berleburg",
  "1004699": "Meschede",
  "1004698": "Menden (Sauerland)",
  "1004664": "Iserlohn",
  "1004716": "Plettenberg",
  "1004713": "Olpe",
  "9048551": "Medebach",
  "9048697": "Rüthen",
  "9048879": "Wilnsdorf",
  "9048588": "Netphen",
  "1004734": "Siegen",
  "9048249": "Brilon",
  "9117191": "59969",
  "9193919": "Bad Laasphe",
  "9048786": "Sundern (Sauerland)",
  "9048156": "Anröchte",
  "1004582": "Arnsberg",
  "1004603": "Burbach",
  "1004684": "Lippstadt",
  "9048219": "Bestwig",
  "9048342": "Finnentrop",
  "1004688": "Lüdenscheid",
  "9048498": "Kreuztal",
  "9048331": "Eslohe (Sauerland)",
  "9048431": "Hilchenbach",
  "9048727": "Schmallenberg",
  "1004760": "Werl",
};

// 2) Keyword-Liste: alle Städte (kleinbuchstabiert) für Keyword-Matching
const cityKeywords = [
  "59969",
  "aachen",
  "ahaus",
  "ahlen",
  "alfter",
  "altena",
  "altenbeken",
  "anröchte",
  "arnsberg",
  "ascheberg",
  "attendorn",
  "augustdorf",
  "bad berleburg",
  "bad honnef",
  "bad laasphe",
  "bad oeynhausen",
  "bad salzuflen",
  "beckum",
  "bedburg",
  "bergheim",
  "bergisch gladbach",
  "bergkamen",
  "bergneustadt",
  "bestwig",
  "beverungen",
  "bielefeld",
  "billerbeck",
  "bochum",
  "bonn",
  "borchen",
  "borgholzhausen",
  "borken",
  "bornheim",
  "bottrop",
  "brakel",
  "brilon",
  "brühl",
  "burbach",
  "burscheid",
  "bünde",
  "castrop-rauxel",
  "coesfeld",
  "datteln",
  "delbrück",
  "detmold",
  "dinslaken",
  "dormagen",
  "dorsten",
  "dortmund",
  "duisburg",
  "dülmen",
  "düsseldorf",
  "emmerich am rhein",
  "emsdetten",
  "engelskirchen",
  "enger",
  "ennepetal",
  "ennigerloh",
  "erftstadt",
  "erndtebrück",
  "eslohe (sauerland)",
  "espelkamp",
  "essen",
  "extertal",
  "finnentrop",
  "frechen",
  "freudenberg",
  "gelsenkirchen",
  "gescher",
  "geseke",
  "gevelsberg",
  "gladbeck",
  "greven",
  "grevenbroich",
  "gummersbach",
  "gütersloh",
  "hagen",
  "haltern am see",
  "halver",
  "hamm",
  "hamminkeln",
  "harsewinkel",
  "hattingen",
  "havixbeck",
  "heek",
  "herdecke",
  "herford",
  "herne",
  "herten",
  "hilchenbach",
  "hilden",
  "horn-bad meinberg",
  "hörstel",
  "hövelhof",
  "höxter",
  "hückeswagen",
  "hünxe",
  "hürth",
  "ibbenbüren",
  "iserlohn",
  "isselburg",
  "jüchen",
  "kaarst",
  "kamen",
  "kamp-lintfort",
  "kerpen",
  "kierspe",
  "kleve",
  "korschenbroich",
  "krefeld",
  "kreuztal",
  "köln",
  "königswinter",
  "kürten",
  "langenfeld (rheinland)",
  "leichlingen (rheinland)",
  "lemgo",
  "lengerich",
  "lennestadt",
  "leverkusen",
  "lichtenau",
  "lindlar",
  "lippstadt",
  "lübbecke",
  "lüdenscheid",
  "lüdinghausen",
  "lünen",
  "marienheide",
  "marl",
  "marsberg",
  "meckenheim",
  "medebach",
  "meerbusch",
  "meinerzhagen",
  "menden (sauerland)",
  "meschede",
  "mettmann",
  "minden",
  "moers",
  "monheim am rhein",
  "morsbach",
  "much",
  "mönchengladbach",
  "mülheim an der ruhr",
  "münster",
  "netphen",
  "neukirchen-vluyn",
  "neunkirchen",
  "neuss",
  "niederkassel",
  "nieheim",
  "nottuln",
  "nümbrecht",
  "oberhausen",
  "ochtrup",
  "odenthal",
  "oelde",
  "oer-erkenschwick",
  "oerlinghausen",
  "olfen",
  "olpe",
  "ostbevern",
  "overath",
  "paderborn",
  "petershagen",
  "plettenberg",
  "porta westfalica",
  "preußisch oldendorf",
  "pulheim",
  "radevormwald",
  "raesfeld",
  "ratingen",
  "recklinghausen",
  "rees",
  "reichshof",
  "remscheid",
  "rheda-wiedenbrück",
  "rhede",
  "rheine",
  "rietberg",
  "rommerskirchen",
  "rosendahl",
  "rösrath",
  "rüthen",
  "salzkotten",
  "sankt augustin",
  "sassenberg",
  "schalksmühle",
  "schermbeck",
  "schieder-schwalenberg",
  "schloß holte-stukenbrock",
  "schmallenberg",
  "schwelm",
  "schwerte",
  "selm",
  "senden",
  "sendenhorst",
  "siegburg",
  "siegen",
  "soest",
  "solingen",
  "sprockhövel",
  "stadtlohn",
  "steinfurt",
  "steinhagen",
  "sundern (sauerland)",
  "südlohn",
  "telgte",
  "troisdorf",
  "unna",
  "velbert",
  "verl",
  "voerde (niederrhein)",
  "vreden",
  "wadersloh",
  "waldbröl",
  "waltrop",
  "warburg",
  "warendorf",
  "warstein",
  "werl",
  "wermelskirchen",
  "wesel",
  "wesseling",
  "wetter (ruhr)",
  "wiehl",
  "wilnsdorf",
  "winterberg",
  "wipperfürth",
  "witten",
  "wuppertal",
  "xanten",
];

// Hilfsfunktion: URL-Parameter auslesen
function getParam(name: string): string | null {
  return new URLSearchParams(window.location.search).get(name);
}

// Core-Funktion zur Stadterkennung
export function detectCity(): string {
  console.log("[CityDetection] start");
  const kw = getParam("kw");                  // Keyword-Param
  const locId = getParam("loc_physical_ms");      // Geo-ID-Param
  let city: string | null = null;

  // 1) Wenn kw vorhanden → Keyword-Match (höchste Priorität)
  if (kw) {
    const kwLower = decodeURIComponent(kw).toLowerCase();
    console.log("[CityDetection] kw:", kwLower);
    for (const name of cityKeywords) {
      if (kwLower.includes(name)) {
        // Erstes, das matched, capitalized
        city = name.charAt(0).toUpperCase() + name.slice(1);
        console.log("[CityDetection] via keyword:", city);
        break;
      }
    }
  }

  // 2) Falls noch keine Stadt und locId vorhanden → Geo-ID-Lookup
  if (!city && locId && geoIdToCity[locId]) {
    city = geoIdToCity[locId];
    console.log("[CityDetection] via Geo-ID:", locId, "→", city);
  }

  // 3) Fallback
  if (!city) {
    city = "Ihrer Stadt";
    console.log("[CityDetection] fallback:", city);
  }

  return city;
}

// Funktion zum Aktualisieren aller Platzhalter-Elemente
export function updateCityPlaceholders(city: string): void {
  // 4) Alle Platzhalter-Elemente befüllen
  document.querySelectorAll(".city-placeholder, .city-welcome, .cityname")
          .forEach(el => {
            if (el instanceof HTMLElement) {
              el.textContent = city;
            }
          });
}

// Initialisierung für Browser-Umgebung
export function initCityDetection(): void {
  const detectAndUpdate = () => {
    const city = detectCity();
    updateCityPlaceholders(city);
  };

  // 5) Aufruf: sofort, nach kurzen Delays und bei SPA-Navigation
  if (typeof document !== 'undefined') {
    if (document.readyState === 'loading') {
      document.addEventListener("DOMContentLoaded", () => {
        detectAndUpdate();
        setTimeout(detectAndUpdate, 500);
        setTimeout(detectAndUpdate, 1500);
      });
    } else {
      detectAndUpdate();
      setTimeout(detectAndUpdate, 500);
      setTimeout(detectAndUpdate, 1500);
    }

    window.addEventListener("popstate", () => setTimeout(detectAndUpdate, 300));
  }
}

// Auto-Initialisierung wenn im Browser
if (typeof window !== 'undefined') {
  initCityDetection();
}
